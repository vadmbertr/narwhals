---
title: "Rapport 28/10/2022"
output:
   bookdown::pdf_document2: default
urlcolor: blue
linkcolor: blue
header-includes:
    \usepackage{float}
    \makeatletter\renewcommand*{\fps@figure}{H}\makeatother
---

```{r setup, echo=FALSE, eval=TRUE}
knitr::opts_chunk$set(echo=FALSE, eval=TRUE,
                      comment=NA, warning=FALSE,
                      message=FALSE)
knitr::opts_chunk$set(fig.width = 8, fig.height = 4, fig.align = "center")
```

```{r}
library(ggplot2)
library(kableExtra)

set.seed(15)
```

\newpage

Nous souhaitons observer chez des narvals l'effet de l'exposition à des perturbations humaines sur leur capacité à se nourrir. Lorsqu'elles se nourissent, ces baleines émettent des sons spécifiques (buzz). Nous nous intéresserons donc à la fréquence d'émission de ces buzz (buzz/min), ce qui peut être modélisé par un modèle de Poisson.

# Sans perturbations

## Estimation de l'effet de la profondeur

Pour se nourrir, les narvals doivent plonger profondément alors que le reste du temps, ils restent "proche" de la surface. Il faut donc inclure au modèle la profondeur à laquelle se trouvent les baleines quand elles émettent ou non des buzz. La relation entre l'émission de buzz et la profondeur n'étant pas linéaire, la profondeur a été remplacée par une variable explicative la décrivant par un polynôme de degré 3.

## Recherche de la mémoire optimale

L'émission d'un buzz à un instant $t$ est corrélé à l'émission ou non de buzz aux instants précédents $t$. Cet effet mémoire doit donc être ajouté au modèle et pour cela nous devons déterminer la mémoire maximum qu'il faut autoriser au modèle.

Afin de trouver la mémoire optimale, nous avons utilisé la démarche suivante :

1. $from.ml = 1,\ to.ml = N$
2. Tant que $(to.ml - from.ml > 2)$ :
   1. Pour $ml^k_i \in [from.ml, to.ml],\ i = 1...M$ :
      1. ajustement d'un modèle de Poisson
      2. calcul du BIC
   2. $i_{opt} = argmin\ BIC_i$
   3. $from.ml = ml^{k}_{i_{opt}-1},\ to.ml = ml^{k}_{i_{opt}+1}$

### Sans effets aléatoires

Dans un premier temps, nous n'avons pas inclus d'effets aléatoires sur les individus pour estimer la mémoire optimale :
$$
Buzz \sim Ind + spline(Depth) + Lag_1 + ... + Lag_N
$$
Nous avons fixé $N = 300$ et $M = 10$.

```{r}
maxlag.bic <- readRDS("../data/glm_buzz_depth_maxlag/maxlag.bic.rds")
maxlag.opt <- as.integer(maxlag.bic[which.min(maxlag.bic[, 2]), 1])
```

Nous obtenons une mémoire optimale de `r maxlag.opt` secondes. La figure \@ref(fig:plot-glm-bic) permet de voir que cet optimal semble bien correspondre à un minimum global.

```{r plot-glm-bic, fig.cap = "BIC en fonction de la mémoire maximum"}
ggplot(maxlag.bic, aes(x = maxlag, y = BIC)) +
  geom_line() +
  geom_vline(xintercept = maxlag.opt, col = "blue", lty = 2) +
  xlab("Mémoire maximum")
```

### Avec effets aléatoires

Nous avons plusieurs observations par individu, ce qui implique qu'elles ne sont pas indépendantes. Pour prendre en compte cette dépendance, nous avons tenté d'inclure un effet aléatoire sur les individus :
$$
Buzz \sim (1 | Ind) + spline(Depth) + Lag_1 + ... + Lag_N
$$
Compte tenu du résultat obtenu précédemment, nous avons tout de suite restreint l'intervalle de recherche initial à $[30, 90]$.

Malheureusement le temps d'ajustement des modèles mixtes (environ 1h30) ne nous a pas permis d'obtenir de résultats pour le moment.

## Régression bi-exponentielle

Nous avons vu que les modèles mixtes sont bien plus longs à ajuster que les modèles "classiques", aussi, afin de réduire le nombre de variables, nous appliquons une régression bi-exponentielle aux coefficients auto-régressifs obtenus précédemment. Ainsi nous passons de `r maxlag.opt` à 4 variables. \newline
La figure \@ref(fig:plot-AR-BiExp) montre les composantes de la mémoire ajustées pour un décalage maximum de `r maxlag.opt`. Les points sont les contributions individuelles de chaque décalage, la courbe correspond à la régression bi-exponentielle.

```{r}
ARcoef.fit <- readRDS("../data/glm_buzz_depth_maxlag/ARcoef.fit.rds")
```

```{r plot-AR-BiExp, fig.cap = "Régression bi-exponentielle des coefficients auto-régressifs"}
ggplot(ARcoef.fit, aes(x = lag, y = truth)) +
  geom_point(alpha = 0.5) +
  geom_line(aes(x = lag, y = estimate)) +
  geom_hline(yintercept = 0, alpha = .5, lty = 2) +
  ylab("Coefficient") + xlab("Mémoire")
```

Les coefficients obtenus suite à la régression bi-exponentielle sont présentés dans la table \@ref(tab:tab-AR-BiExp).

```{r}
ARcoef.RegBiExp <- readRDS("../data/glm_buzz_depth_maxlag/ARcoef.RegBiExp.rds")
```

```{r tab-AR-BiExp}
kable(ARcoef.RegBiExp, caption = "Coefficients obtenus par régression bi-exponentielle",
      label="tab-AR-BiExp") %>%
  kable_styling(latex_options = "HOLD_position")
```

# Estimation de l'effet de l'exposition

L'exposition aux perturbations est exprimée par $1/dist$ où $dist$ est la distance en kilomètres séparant l'animal du bateau dont émane la perturbation.

Nous avons ajusté le modèle mixte suivant :
$$
Buzz \sim (1 | Ind) + offset(ARDepth) + spline(Expo)
$$

```{r}
acf.plot.data <- readRDS("../data/glmer_buzz_ARDepth_expo/acf.plot.data.rds")
QQ.plot.data <- readRDS("../data/glmer_buzz_ARDepth_expo/QQ.plot.data.rds")
z.plot.data <- readRDS("../data/glmer_buzz_ARDepth_expo/z.plot.data.rds")
```

```{r}
# ggplot(data = acf.plot.data, aes(x = lag, y = acf)) +
#   geom_col(size = 0.2) + coord_fixed(36) +
#   ylab("Autocorrelation of uniform residuals") +
#   xlab("Lag")
```

```{r}
# ggplot(data = z.plot.data, aes(x = Zlow, y = Zupp)) +
#   geom_point(size = 0.5) + coord_fixed(1) +
#   xlab(expression(Z[i-1])) +
#   ylab(expression(Z[i])) +
#   geom_abline(slope = 1, intercept = 0, size = 1)
```

```{r}
# ggplot(QQ.plot.data, aes(x=qunif, y=Zorder))+
#   geom_point()+
#   xlab("Uniform theoretical quantiles")+
#   ylab("Empirical quantiles")
```
