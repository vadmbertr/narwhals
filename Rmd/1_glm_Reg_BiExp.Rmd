---
output: pdf_document
---
```{r,echo=F,warning=F}
library(ggplot2)
library(readr)
coeff<-read_rds("../data/glm_buzz_depth_maxlag/ARcoefs.best.rds")
BIC<-read_rds("../data/glm_buzz_depth_maxlag/maxlag_bic.rds")
```

La figure suivante montre les composantes de la mémoire ajustées pour chaque décalage pour un décalage maximum de 60. Les points sont les estimations individuelles pour chaque décalage, la courbe correspond à la fonction bi-exponentielle ajustée utilisée pour la détermination finale de la composante mémoire.


```{r,echo=F,warning=F}
## Estimation of the AR coefficients.

lag     <- as.integer(BIC[which.min(BIC[, 2]), 1])
ARcoef  <- coeff[-(1:10),"Estimate"]

fitresult <- data.frame(maxlag = as.factor(rep(lag, lag)), lag = 1:lag,
                        truth = ARcoef)

std.err <- coeff[-(1:10),"Std. Error"]
w       <- 1/std.err
n       <- length(ARcoef)
fm <- nls(ARcoef ~ SSbiexp(1:n, A1, lrc1, A2, lrc2), weights = w)
b1 <- summary(fm)$coefficients[1,1]
b2 <- exp(summary(fm)$coefficients[2,1])
b3 <- summary(fm)$coefficients[3,1]
b4 <- exp(summary(fm)$coefficients[4,1])
curvefit  <- data.frame(maxlag = as.factor(rep(lag, lag)), lag = 1:lag,
                        b1 = rep(b1, lag), b2 = rep(b2, lag),
                        b3 = rep(b3, lag), b4 = rep(b4, lag))
curvefit$estimate <- curvefit$b1 * exp(-curvefit$b2 * curvefit$lag) +
  curvefit$b3 * exp(-curvefit$b4 * curvefit$lag)

ARcoef.fit <- fitresult
ARcoef.fit$estimate <- curvefit$b1 * exp(-curvefit$b2 * curvefit$lag) +
  curvefit$b3 * exp(-curvefit$b4 * curvefit$lag)
saveRDS(ARcoef.fit,file="../data/glm_buzz_depth_maxlag/ARcoef.fit.rds")
```

```{r,echo=F,warning=F,fig.cap="Régression bi-exponentielle des coefficients auto-régressifs"}
ggplot(ARcoef.fit, aes(x = lag, y = truth, color = maxlag)) +
  geom_point(alpha = 0.3) +
  geom_line(aes(x = lag, y = estimate, color = maxlag)) +
  geom_hline(yintercept = 0) +
  theme(legend.position="top")
```

Les coefficients obtenus suite à la régression bi-exponentielle sont présentés dans la table suivante :
 
```{r,echo=F,warning=F}
# Enregistrement des coefficients dans un fichier
C<-curvefit[1,-c(1,2,7)]
rownames(C)<-NULL
glm_coefficients_RegBiExp<-C
saveRDS(glm_coefficients_RegBiExp,file= "../data/glm_buzz_depth_maxlag/ARcoef.RegBiExp.rds")
```

```{r,echo = F}
knitr::kable(glm_coefficients_RegBiExp,caption="Coefficients obtenus par régression bi-exponentielle pour le modèle GLM prenant en compte les individus, la profondeur ainsi qu'un lag maximum de 60 pour la mémoire")
```

